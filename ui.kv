#:import Factory kivy.factory.Factory

<MainWindow>:
    screen_manager: screen_manager
    device_rv: device_rv
    home_btn: home_btn
    new_device_btn: new_device_btn
    DeviceRV:
        id: device_rv
    HomeButton:
        id: home_btn
    NewDeviceButton:
        id: new_device_btn
    ScreenManager:
        id: screen_manager
        home:home
        device:device
        HomeScreen:
            id:home
        DeviceScreen:
            id:device

<DeviceRV>:
    size_hint: .2, 0.7
    pos_hint: {"x":0, "top":.85}
    background_color: 0.0,0.50,0,1
    viewclass: 'ConnectedDeviceSelectableLabel'
    SelectableRecycleBoxLayout:
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'
        multiselect: False
        touch_multiselect: False
        spacing: 2

<AddDeviceSelectableLabel>:
    # Draw a background to indicate selection
    canvas.before:
        Color:
            rgba: (.0, 0.9, .1, .3) if self.selected else (0, 0, 0, 1)
        Rectangle:
            pos: self.pos
            size: self.size

<ConnectedDeviceSelectableLabel>:
    # Draw a background to indicate selection
    _label:_label
    working_image_1: working_image_1
    working_image_2:working_image_2
    working_image_3:working_image_3
    malfunction_image:malfunction_image
    delete_image:delete_image
    rename_image:rename_image
    battery_image:battery_image
    battery_percent:battery_percent
    canvas.before:
        Color:
            rgba: (.0, 0.9, .1, .3) if self.selected else (0.1, 0, 0.1, 1)
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        id: _label
        size_hint: 1, .2
        color: 1, 1, 0, 1
        font_size: 16
        valign: 'top'
        halign: 'center'
        pos_hint: {"x":0, "top":.95}
    Image:
        id: working_image_1
        size_hint: .125, .125
        pos_hint: {"x":0.05, "top":0.6}
        source: './Icon2/working.png'
    Image:
        id: working_image_2
        size_hint: .125, .125
        pos_hint: {"x":0.2, "top":0.6}
        source: './Icon2/working.png'
    Image:
        id: working_image_3
        size_hint: .125, .125
        pos_hint: {"x":0.35, "top":0.6}
        source: './Icon2/not_working.png'
    Image:
        id: malfunction_image
        size_hint: .125, .125
        pos_hint: {"x":0.825, "top":0.6}
        source: './Icon2/malfunction.png'
    Image:
        id: delete_image
        size_hint: .2, .2
        pos_hint: {"x":0.75, "top":0.25}
        source: './Icon2/delete.png'
    Image:
        id: rename_image
        size_hint: .2, .2
        pos_hint: {"x":0.55, "top":0.25}
        source: './Icon2/Rename.png'
    Image:
        id: battery_image
        size_hint: .2, .2
        pos_hint: {"x":0.05, "top":0.25}
        source: './Icon2/battery.png'
    Label:
        id: battery_percent
        size_hint: .2, .2
        pos_hint: {"x":0.275, "top":0.25}
        text: "89%"


<HomeButton@Button>
    font_size: 20
    color: .1,.5,.6,1
    size_hint: 0.2, 0.15
    text: "HOME"
    pos_hint: {"x":0, "top":1}
    background_color: 0.1,0.2,0.3,1
    on_press:
        app.root.screen_manager.transition.direction = 'up'
        app.root.current = 'home'

<AddDevicePopup@Popup>:
    auto_dismiss: False
    title: "Add Device"
    ble_rv: ble_rv
    size_hint: .8,.8
    on_open: root.BluetoothDiscoverLoop()
    FloatLayout:
        RecycleView:
            id: ble_rv
            size_hint: 1, 0.9
            pos_hint: {"x":0, "top":1}
            background_color: 0.0,0.50,0,1
            viewclass: 'AddDeviceSelectableLabel'
            SelectableRecycleBoxLayout:
                default_size: None, dp(56)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                multiselect: True
                touch_multiselect: True
        Button:
            text: "Add Devices"
            size_hint: 1, 0.1
            pos_hint: {"x":0, "top":.1}
            background_color: 0.0,0.50,0,1
            on_press: root.Close()

<NewDeviceButton@Button>
    font_size: 20
    color: .1,.5,.6,1
    size_hint: 0.2, 0.15
    text: "New Device"
    pos_hint: {"x":0, "bottom":1}
    background_color: 0.2,0.5,0.3,1
    on_release: Factory.AddDevicePopup().open()

<BeginnerTutorial@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Beginner Tutorial"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.3, 0.35
    pos_hint: {"x":0.65, "top":0.95}

<GetHelp@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Get Help"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.12, 0.08
    font_size: 15
    pos_hint: {"x":0.65, "top":0.53}

<ReportBug@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Report Bug"
    font_size: 15
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.12, 0.08
    pos_hint: {"x":0.83, "top":0.53}

<LatestUpdate@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Latest Update"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.25, 0.5
    pos_hint: {"x":0.3, "top":0.95}

<SettingsHome@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Settings"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.65, 0.3
    pos_hint: {"x":0.3, "top":0.375}

<CathodicAnodicToggle@BoxLayout>:
    pos_hint: {"x":0.075, "top":.6}
    size_hint: .85,.06
    ToggleButton:
        text: "Cathodic First"
        font_size: 14
        group: "cathodic_anodic"
    ToggleButton:
        text: "Anodic First"
        group: "cathodic_anodic"
        font_size: 14

<TerminationTabs>:
    tab_width: (self.parent.width*.85)/3
    pos_hint: {"x":0.075, "top":.45}
    size_hint: .85,.25
    do_default_tab: False
    TabbedPanelItem:
        text: "Time"
        font_size: 14
        group: "termination"
        FloatLayout:
            Label:
                pos_hint: {"x":0, "top":.99}
                size_hint: 1,.3
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                text: " Number of Minutes"
            TextInput:
                pos_hint: {"x":0, "top":.69}
                size_hint: 1,.69
                text: "0"
                multiline:False
    TabbedPanelItem:
        text: "Duty Cycle"
        group: "termination"
        font_size: 14
        FloatLayout:
            Label:
                pos_hint: {"x":0, "top":.99}
                size_hint: 1,.3
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                text: " Number of Cycles"
            TextInput:
                pos_hint: {"x":0, "top":.69}
                size_hint: 1,.69
                text: "0"
                multiline: False
    TabbedPanelItem:
        text: "Non-Stop"
        group: "termination"
        font_size: 14

<DeviceSettings@BoxLayout>:
    size_hint: 1,1
    pos_hint: {"x":0, "top":1}
    orientation: 'vertical'
    ChannelStimulationTabs:


<PhaseTimeFrequencyTabs>:
    tab_width: (self.parent.width*.995)/2
    size_hint: .995,1
    pos_hint: {"x":0, "top":1}
    do_default_tab: False
    color: .2,.2,.1,1
    background_color: 0.1,0.2,0.3,1
    inter_phase_delay_input:inter_phase_delay_input
    phase_time_input:phase_time_input
    TabbedPanelItem:
        text: "Phase Time"
        FloatLayout:
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":1}
                text: "Inter-Phase Delay"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                id: inter_phase_delay_input
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":0.75}
                text: ""
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":1}
                text: "Phase Time"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                id: phase_time_input
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":0.75}
                text: ""
    TabbedPanelItem:
        text: "Frequency"

<ChannelPanel@BoxLayout>:
    orientation: 'vertical'
    BoxLayout:
        orientation: 'horizontal'
        BoxLayout:
            orientation: 'vertical'
            PhaseTimeFrequencyTabs:
            BurstUniformStimulationTabs:
        FloatLayout:
            Button:
                size_hint: .25,.06
                pos_hint: {"x":0.075, "top":.99}
                text: "Stop"
            Button:
                size_hint: .25,.06
                pos_hint: {"x":0.375, "top":.99}
                text: "Save"
            Button:
                size_hint: .25,.06
                pos_hint: {"x":0.675, "top":.99}
                text: "Start"
            Label:
                size_hint: .4,.05
                pos_hint: {"x":0.075, "top":.9}
                text: "Output Current (A)"
            TextInput:
                size_hint: .4,.08
                pos_hint: {"x":0.075, "top":.85}
                text: "0"
            Label:
                size_hint: .4,.05
                pos_hint: {"x":0.075, "top":.5}
                text: "End Stimulation By:"
            TerminationTabs:
            CathodicAnodicToggle:
            ToggleButton:
                size_hint: .4,.06
                pos_hint: {"x":0.075, "top":0.7}
                text: "Ramp Up"
                group: "ramp_up"
            ToggleButton:
                size_hint: .4,.06
                pos_hint: {"x":0.525, "top":0.7}
                text: "Short Electrode"
                group: "electrode"
            Button:
                size_hint: .4,.1
                pos_hint: {"x":0.525, "top":0.15}
                text: "Generate Graph"
                group: "electrode"
    BoxLayout:
        size_hint: 1,.5
        pos_hint: {"x":0, "top":1}
        Button:
            text:"x"

<ChannelStimulationTabs>:
    tab_width: (self.parent.width)/2
    size_hint: .995,1
    pos_hint: {"x":0, "top":1}
    do_default_tab: False
    color: .2,.2,.1,1
    background_color: 0.1,0.2,0.3,1
    channel_1_panel:channel_1_panel
    channel_2_panel:channel_2_panel
    TabbedPanelItem:
        text: "Channel 1"
        ChannelPanel:
            id: channel_1_panel
    TabbedPanelItem:
        text: "Channel 2"
        ChannelPanel:
            id: channel_2_panel

<BurstUniformStimulationTabs>:
    tab_width: (self.parent.width*.995)/2
    size_hint: .995,1
    pos_hint: {"x":0, "top":1}
    do_default_tab: False
    color: .2,.2,.1,1
    background_color: 0.1,0.2,0.3,1
    burst_duration_input:burst_duration_input
    inter_burst_delay:inter_burst_delay
    TabbedPanelItem:
        text: "Burst Stimulation"
        FloatLayout:
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":1}
                text: "Burst Duration"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                id:burst_duration_input
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":0.75}
                text: ""
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":1}
                text: "Inter-Burst Delay"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                id:inter_burst_delay
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":0.75}
                text: ""
    TabbedPanelItem:
        text: "Uniform Stimulation"

<DeviceTabs>:
    stimulation_log_tab: stimulation_log_tab
    advanced_settings: advanced_settings
    size_hint: .8,1
    pos_hint: {"x":.2, "top":1}
    do_default_tab: False
    tab_width: (self.parent.width*.8)/4
    TabbedPanelItem:
        text: "Stimulation Setting"
        DeviceSettings:
    TabbedPanelItem:
        text: "Stimulation Log"
        StimulationLogTab:
            id: stimulation_log_tab
    TabbedPanelItem:
        text: "EEG recording"
    TabbedPanelItem:
        text: "Advanced Settings"
        DeviceAdvancedSettings:
            id: advanced_settings

<StimulationLogTab@FloatLayout>:
    top_graph:top_graph
    bottom_graph:bottom_graph
    size_hint: 1,1
    pos_hint: {"x":0, "top":1}
    stop_button:stop_button
    recording_button:recording_button
    save_log_button:save_log_button
    Label:
        text: "Sample info (1k)"
        size_hint: .16, .08
        pos_hint: {"x":0.05,"top":0.95}
    TextInput:
        text: "0"
        size_hint: .16, .06
        pos_hint: {"x":0.25,"top":0.94}
        multiline:False
    Button:
        id: stop_button
        size_hint: .16,0.06
        pos_hint: {"x":0.59,"top":0.94}
        text: "Stop"
    Button:
        id: recording_button
        size_hint: .16,0.06
        pos_hint: {"x":0.79,"top":0.94}
        text: "Recording..."
    Button:
        id: save_log_button
        size_hint: .16,0.06
        pos_hint: {"x":0.79,"top":0.85}
        text: "Save Log"
    FloatLayout:
        id: top_graph
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        size_hint: .9,0.33
        pos_hint: {"x":0.05,"top":0.75}
    FloatLayout:
        id: bottom_graph
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        size_hint: .9,0.33
        pos_hint: {"x":0.05,"top":0.375}

<DeviceAdvancedSettings@FloatLayout>:
    size_hint: 1,1
    pos_hint: {"x":0, "top":1}
    Label:
        text: "General"
        font_size: 15
        size_hint: 0.9, .08
        pos_hint: {"x":0.05,"top":1}
        multiline: False
        text_size:self.size
        halign:'left'
        valign:'middle'
    Label:
        text: "Stimulation Setting"
        font_size: 15
        size_hint: 0.9, .08
        pos_hint: {"x":0.05,"top":0.675}
        multiline: False
        text_size:self.size
        halign:'left'
        valign:'middle'
    StrokeButton:
        size_hint: 0.425, .08
        pos_hint: {"x":0.05,"top":0.9}
        font_size: 13
        text: "Auto shutdown when stimulation is finished"
        group: "finished_shutdown"
    StrokeButton:
        size_hint: 0.425, .08
        pos_hint: {"x":0.525,"top":0.9}
        font_size: 13
        text: "Auto shutdown when surge is detected"
        group: "shutdown_surge"
    SmoothButton:
        size_hint: 0.2, .08
        pos_hint: {"x":0.05,"top":0.7825}
        font_size: 13
        text: "Firmware Info"
    SmoothButton:
        size_hint: 0.2, .08
        pos_hint: {"x":0.3,"top":0.7825}
        font_size: 13
        text: "Hardware Info"
    SmoothButton:
        size_hint: 0.2, .08
        pos_hint: {"x":0.55,"top":0.7825}
        font_size: 13
        text: "Bootloader Access"
    StrokeButton:
        size_hint: 0.16, .08
        pos_hint: {"x":0.05,"top":0.6}
        font_size: 13
        text: "Ramp Up"
        group: "ramp_up"
    RampUpInput:
    StrokeButton:
        size_hint: 0.16, .08
        pos_hint: {"x":0.25,"top":0.6}
        font_size: 13
        text: "Short"
        group: "short"
    SmoothButton:
        size_hint: 0.2, .08
        pos_hint: {"x":0.45,"top":0.6}
        font_size: 13
        text: "Continuity Check"
    StrokeButton:
        size_hint: 0.16, .08
        pos_hint: {"x":0.79,"top":0.6}
        font_size: 13
        text: "Triggered Mode"
        group:"triggered_mode"
    TriggeredModeToggle:
    Label:
        text: "Diagnostic Tools"
        font_size: 15
        size_hint: 0.9, .08
        pos_hint: {"x":0.05,"top":0.375}
        multiline: False
        text_size:self.size
        halign:'left'
        valign:'middle'
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.05,"top":0.3}
        font_size: 13
        text: "Ramp DAC"
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.285,"top":0.3}
        font_size: 13
        text: "Phase 1"
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.53,"top":0.3}
        font_size: 13
        text: "Phase 2"
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.765,"top":0.3}
        font_size: 13
        text: "All Off"
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.05,"top":0.2}
        font_size: 13
        text: "Null Command"
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.285,"top":0.2}
        font_size: 13
        text: "Test Trigger"
    SmoothButton:
        size_hint: 0.185, .08
        pos_hint: {"x":0.53,"top":0.2}
        font_size: 13
        text: "Debug Mode"

<RampUpInput@FloatLayout>:
    size_hint: 0.16, .1
    pos_hint: {"x":0.05,"top":0.5}
    background_color: (0, 0, 0, 0)
    background_normal: ''
    back_color: 0.16, 0.45, 0.75, 1
    border_radius: 5
    color: 0,0,0,1
    canvas.before:
        Color:
            rgba: self.back_color
        Line:
            rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], self.border_radius)
            width: 1.2
    Label:
        text: "Ramp Up (ms)"
        size_hint: .9, 0.4
        font_size: 12
        pos_hint: {"x":0.05,"top":.95}
        multiline: False
    TextInput:
        text: "0"
        size_hint: 0.9, 0.45
        font_size: 12
        multiline:False
        pos_hint: {"x":0.05,"top":.55}

<TriggeredModeToggle@FloatLayout>:
    size_hint: 0.65, .1
    pos_hint: {"x":0.3,"top":0.5}
    background_color: (0, 0, 0, 0)
    background_normal: ''
    back_color: 0.16, 0.45, 0.75, 1
    border_radius: 5
    color: 0,0,0,1
    canvas.before:
        Color:
            rgba: self.back_color
        Line:
            rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], self.border_radius)
            width: 1.2
    StrokeButton:
        size_hint: 0.15, .8
        pos_hint: {"x":0.025,"top":0.9}
        font_size: 11
        text: "None"
        state: "down"
        group:"trigger_mode"
        text_size: self.size
        halign: 'center'
        valign: 'middle'
    StrokeButton:
        size_hint: 0.15, .8
        pos_hint: {"x":0.225,"top":0.9}
        font_size: 11
        text: "Phase 1"
        group:"trigger_mode"
        text_size: self.size
        halign: 'center'
        valign: 'middle'
    StrokeButton:
        size_hint: 0.15, .8
        pos_hint: {"x":0.425,"top":0.9}
        font_size: 11
        text: "Phase 2"
        group:"trigger_mode"
        text_size: self.size
        halign: 'center'
        valign: 'middle'
    StrokeButton:
        size_hint: 0.15, .8
        pos_hint: {"x":0.625,"top":0.9}
        font_size: 11
        text: "Phase\n1 & 2"
        group:"trigger_mode"
        text_size: self.size
        halign: 'center'
        valign: 'middle'
    StrokeButton:
        size_hint: 0.15, .8
        pos_hint: {"x":0.825,"top":0.9}
        font_size: 11
        text: "Inter-Stim\nTime"
        group:"trigger_mode"
        text_size: self.size
        halign: 'center'
        valign: 'middle'

<SmoothButton@Button>:
    background_color: (0, 0, 0, 0)
    background_normal: ''
    back_color: 0.16, 0.45, 0.75, 1
    border_radius: [5]
    canvas.before:
        Color:
            rgba: self.back_color
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: self.border_radius

<SmoothToggleButton@ToggleButton>:
    background_color: (0, 0, 0, 0)
    background_normal: ''
    back_color: 0.16, 0.45, 0.75, 1
    border_radius: [5]
    canvas.before:
        Color:
            rgba: self.back_color
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: self.border_radius

<StrokeButton@Button>:
    background_color: (0.16, 0.45, 0.75, 1) if self.state=='down' else (0, 0, 0, 0)
    background_normal: ''
    back_color: 0.16, 0.45, 0.75, 1
    border_radius: 5
    color: 0,0,0,1
    bold: True
    canvas.before:
        Color:
            rgba: self.back_color
        Line:
            rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], self.border_radius)
            width: 1.2

<HomeScreen>:
    name: "home"
    beginner_tutorial:beginner_tutorial
    get_help:get_help
    latest_update:latest_update
    report_bug:report_bug
    settings_home:settings_home
    FloatLayout:
        BeginnerTutorial:
            id: beginner_tutorial
        GetHelp:
            id: get_help
        LatestUpdate:
            id: latest_update
        ReportBug:
            id: report_bug
        SettingsHome:
            id: settings_home

<DeviceScreen>:
    name: "device"
    device_tabs: device_tabs
    FloatLayout:
        DeviceTabs:
            id: device_tabs