#:import Factory kivy.factory.Factory
<MainWindow>:
    screen_manager: screen_manager
    side_bar: side_bar
    canvas.before:
        Rectangle:
            size: self.size
            pos:self.pos
    FloatLayout:
        SideBar:
            id: side_bar
            size_hint:0.2,1
            pos_hint:{"x":0}
        ScreenManagement:
            id: screen_manager
            size_hint:0.8,1
            pos_hint:{"x":0.2}
<SideBar>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgb: .172,.184,.196
        Rectangle:
            size: self.size
            pos:self.pos
    device_rv:device_rv
    Label:
        text:"NeuroStim"
        color:1,1,1,1
        font_size:45
        size_hint:1,0.1
        pos_hint:{"top":1}
    HomeButton:
    NewDeviceButton:
    DeviceRV:
        id: device_rv

<ScreenManagement>
    HomeScreen:
    DeviceScreen:

<HomeScreen>:
    name: "home"
    canvas.before:
        Color:
            rgb:1,1,1
        Rectangle:
            size: self.size
            pos:self.pos
    FloatLayout:
        BeginnerTutorial:
            size_hint: 0.25, 0.2
            title: 'Drag me'
        GetHelp:
        LatestUpdate:
        ReportBug:
        SettingsHome:



<DeviceScreen>:
    name: "device"
    canvas.before:
        Color:
            rgb:1,1,1
        Rectangle:
            size: self.size
            pos:self.pos
    device_tabs: device_tabs
    DeviceTabs:
        id: device_tabs

###widgets for homescreen###
##################################################
<BeginnerTutorial@Button+DragBehavior>:
    drag_rectangle: self.x, self.y, self.width, self.height
    drag_timeout: 10000000
    drag_distance: 0


<GetHelp@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Get Help"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.12, 0.08
    font_size: 15
    pos_hint: {"x":0.65, "top":0.53}

<ReportBug@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Report Bug"
    font_size: 15
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.12, 0.08
    pos_hint: {"x":0.83, "top":0.53}

<LatestUpdate@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Latest Update"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.25, 0.5
    pos_hint: {"x":0, "top":0.95}

<SettingsHome@Button>:
    font_size: 20
    color: .1,.5,.6,1
    text: "Settings"
    background_color: 0.2,0.5,0.3,1
    size_hint: 0.65, 0.3
    pos_hint: {"x":0.3, "top":0.375}
##################################################


###widgets for sidebar###
##################################################
<DeviceRV>:
    size_hint: 1, 0.7
    pos_hint: {"x":0, "top":.85}
    background_color: 0.0,0.50,0,1
    viewclass: 'ConnectedDeviceSelectableLabel'
    SelectableRecycleBoxLayout:
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'
        multiselect: False
        touch_multiselect: False
        spacing: 2

<AddDeviceSelectableLabel>:
    # Draw a background to indicate selection
    color:0,0,0,1
    canvas.before:
        Color:
            rgba: (.0, 0.9, .1, .3) if self.selected else (1, 1, 1, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size

<ConnectedDeviceSelectableLabel>:
    # Draw a background to indicate selection
    _label:_label
    canvas.before:
        Color:
            rgba: (.0, 0.9, .1, .3) if self.selected else (0.1, 0, 0.1, 1)
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        id: _label
        size_hint: 1, .2
        color: 1, 1, 0, 1
        font_size: 16
        valign: 'top'
        halign: 'center'
        pos_hint: {"x":0, "top":.95}
    Image:
        size_hint: .125, .125
        pos_hint: {"x":0.05, "top":0.6}
        source: './Icon2/working.png'
    Image:
        size_hint: .125, .125
        pos_hint: {"x":0.2, "top":0.6}
        source: './Icon2/working.png'
    Image:
        size_hint: .125, .125
        pos_hint: {"x":0.35, "top":0.6}
        source: './Icon2/not_working.png'
    Image:
        size_hint: .125, .125
        pos_hint: {"x":0.825, "top":0.6}
        source: './Icon2/malfunction.png'
    Image:
        size_hint: .2, .2
        pos_hint: {"x":0.75, "top":0.25}
        source: './Icon2/delete.png'
    Image:
        size_hint: .2, .2
        pos_hint: {"x":0.55, "top":0.25}
        source: './Icon2/Rename.png'
    Image:
        size_hint: .2, .2
        pos_hint: {"x":0.05, "top":0.25}
        source: './Icon2/battery.png'
    Label:
        size_hint: .2, .2
        pos_hint: {"x":0.275, "top":0.25}
        text: "89%"


<HomeButton@Button>
    text: "Home"
    font_size: 30
    color: 1,1,1,1
    size_hint: 1, 0.05
    pos_hint: {"top":0.9}
    background_color: .4,.4,.4,1
    on_press:
        app.root.screen_manager.transition.direction = 'down'
        app.root.screen_manager.current = 'home'

<AddDevicePopup>:
    title: "Bluetooth Discovery"
    title_size:35
    title_align:'center'
    separator_height:0
    ble_rv: ble_rv
    size_hint: .45,.73
    pos_hint: {"center_x":0.5,"center_y":0.5}
    auto_dismiss : True
    on_open: root.BluetoothDiscoverLoop()
    FloatLayout:
        canvas.before:
            Color:
                rgb:0.878,0.898,0.933
            Rectangle:
                size:self.size
                pos:self.pos
        RecycleView:
            id: ble_rv
            size_hint: 1, 0.895
            pos_hint: {"x":0, "top":1}
            viewclass: 'AddDeviceSelectableLabel'
            SelectableRecycleBoxLayout:
                default_size: None, dp(56)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                multiselect: False
                touch_multiselect: False
                spacing:dp(2)
        Label:
            size_hint: 1, 0.1
            pos_hint: {"x":0, "y":0}
            canvas.before:
                Color:
                    rgb:0.953,0.9608,0.9765
                Rectangle:
                    size:self.size
                    pos:self.pos
        Button:
            text: "Connect"
            size_hint: 0.3, 0.08
            pos_hint: {"x":0.65, "top":.09}
            background_color: 0.420,0.864,1.773,1
            on_press: root.Close()
        Button:
            text: "Refresh"
            size_hint: 0.3, 0.08
            pos_hint: {"x":0.05, "top":.09}
            background_color: 1,1,1,1
            on_press: root.BluetoothDiscoverLoop()

<NewDeviceButton@Button>
    font_size: 30
    color: 1,1,1,1
    size_hint: 1, 0.06
    text: "+ New Device"
    pos_hint: {"bottom":1}
    background_color: 0.420,0.864,1.773,1
    on_release: Factory.AddDevicePopup().open()
##################################################0.3451


###widgets for device screen###
##################################################
<CathodicAnodicToggle@BoxLayout>:
    pos_hint: {"x":0.075, "top":.6}
    size_hint: .85,.06
    ToggleButton:
        text: "Cathodic First"
        font_size: 14
        group: "cathodic_anodic"
    ToggleButton:
        text: "Anodic First"
        group: "cathodic_anodic"
        font_size: 14

<TerminationTabs>:
    tab_width: (self.parent.width*.85)/3
    pos_hint: {"x":0.075, "top":.45}
    size_hint: .85,.25
    do_default_tab: False
    TabbedPanelItem:
        text: "Time"
        font_size: 14
        group: "termination"
        FloatLayout:
            Label:
                pos_hint: {"x":0, "top":.99}
                size_hint: 1,.3
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                text: " Number of Minutes"
            TextInput:
                pos_hint: {"x":0, "top":.69}
                size_hint: 1,.69
                text: "0"
                multiline:False
    TabbedPanelItem:
        text: "Duty Cycle"
        group: "termination"
        font_size: 14
        FloatLayout:
            Label:
                pos_hint: {"x":0, "top":.99}
                size_hint: 1,.3
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                text: " Number of Cycles"
            TextInput:
                pos_hint: {"x":0, "top":.69}
                size_hint: 1,.69
                text: "0"
                multiline: False
    TabbedPanelItem:
        text: "Non-Stop"
        group: "termination"
        font_size: 14

<DeviceSettings@BoxLayout>:
    size_hint: 1,1
    pos_hint: {"x":0, "top":1}
    orientation: 'vertical'
    ChannelStimulationTabs:


<PhaseTimeFrequencyTabs>:
    tab_width: (self.parent.width*.995)/2
    size_hint: .995,1
    pos_hint: {"x":0, "top":1}
    do_default_tab: False
    color: .2,.2,.1,1
    background_color: 0.1,0.2,0.3,1
    TabbedPanelItem:
        text: "Phase Time"
        FloatLayout:
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":1}
                text: "Inter-Phase Delay"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":0.75}
                text: ""
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":1}
                text: "Phase Time"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":0.75}
                text: ""
    TabbedPanelItem:
        text: "Frequency"

<ChannelStimulationTabs>:
    tab_width: (self.parent.width)/2
    size_hint: .995,1
    pos_hint: {"x":0, "top":1}
    do_default_tab: False
    color: .2,.2,.1,1
    background_color: 0.1,0.2,0.3,1
    TabbedPanelItem:
        text: "Channel 1"
        BoxLayout:
            orientation: 'vertical'
            BoxLayout:
                orientation: 'horizontal'
                BoxLayout:
                    orientation: 'vertical'
                    PhaseTimeFrequencyTabs:
                    BurstUniformStimulationTabs:
                FloatLayout:
                    Button:
                        size_hint: .25,.06
                        pos_hint: {"x":0.075, "top":.99}
                        text: "Stop"
                    Button:
                        size_hint: .25,.06
                        pos_hint: {"x":0.375, "top":.99}
                        text: "Save"
                    Button:
                        size_hint: .25,.06
                        pos_hint: {"x":0.675, "top":.99}
                        text: "Start"
                    Label:
                        size_hint: .4,.05
                        pos_hint: {"x":0.075, "top":.9}
                        text: "Output Current (A)"
                    TextInput:
                        size_hint: .4,.08
                        pos_hint: {"x":0.075, "top":.85}
                        text: "0"
                    Label:
                        size_hint: .4,.05
                        pos_hint: {"x":0.075, "top":.5}
                        text: "End Stimulation By:"
                    TerminationTabs:
                    CathodicAnodicToggle:
                    ToggleButton:
                        size_hint: .4,.06
                        pos_hint: {"x":0.075, "top":0.7}
                        text: "Ramp Up"
                        group: "ramp_up"
                    ToggleButton:
                        size_hint: .4,.06
                        pos_hint: {"x":0.525, "top":0.7}
                        text: "Short Electrode"
                        group: "electrode"
                    Button:
                        size_hint: .4,.1
                        pos_hint: {"x":0.525, "top":0.15}
                        text: "Generate Graph"
                        group: "electrode"
            BoxLayout:
                size_hint: 1,.5
                pos_hint: {"x":0, "top":1}
                Button:
                    text:"x"
    TabbedPanelItem:
        text: "Channel 2"
        BoxLayout:
            orientation: 'vertical'
            BoxLayout:
                orientation: 'horizontal'
                BoxLayout:
                    orientation: 'vertical'
                    PhaseTimeFrequencyTabs:
                    BurstUniformStimulationTabs:
                FloatLayout:
                    Button:
                        size_hint: .25,.06
                        pos_hint: {"x":0.075, "top":.99}
                        text: "Stop"
                    Button:
                        size_hint: .25,.06
                        pos_hint: {"x":0.375, "top":.99}
                        text: "Save"
                    Button:
                        size_hint: .25,.06
                        pos_hint: {"x":0.675, "top":.99}
                        text: "Start"
                    Label:
                        size_hint: .4,.05
                        pos_hint: {"x":0.075, "top":.9}
                        text: "Output Current (A)"
                    TextInput:
                        size_hint: .4,.08
                        pos_hint: {"x":0.075, "top":.85}
                        text: "0"
                    Label:
                        size_hint: .4,.05
                        pos_hint: {"x":0.075, "top":.5}
                        text: "End Stimulation By:"
                    TerminationTabs:
                    CathodicAnodicToggle:
                    ToggleButton:
                        size_hint: .4,.06
                        pos_hint: {"x":0.075, "top":0.7}
                        text: "Ramp Up"
                        group: "ramp_up"
                    ToggleButton:
                        size_hint: .4,.06
                        pos_hint: {"x":0.525, "top":0.7}
                        text: "Short Electrode"
                        group: "electrode"
                    Button:
                        size_hint: .4,.1
                        pos_hint: {"x":0.525, "top":0.15}
                        text: "Generate Graph"
                        group: "electrode"
            BoxLayout:
                size_hint: 1,.5
                pos_hint: {"x":0, "top":1}
                Button:
                    text:"x"

<BurstUniformStimulationTabs>:
    tab_width: (self.parent.width*.995)/2
    size_hint: .995,1
    pos_hint: {"x":0, "top":1}
    do_default_tab: False
    color: .2,.2,.1,1
    background_color: 0.1,0.2,0.3,1
    TabbedPanelItem:
        text: "Burst Stimulation"
        FloatLayout:
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":1}
                text: "Burst Duration"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                size_hint: .4,.25
                pos_hint: {"x":0.05, "top":0.75}
                text: ""
            Label:
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":1}
                text: "Inter-Burst Delay"
                text_size: self.size
                halign: 'left'
                valign: 'middle'
            TextInput:
                size_hint: .4,.25
                pos_hint: {"x":0.55, "top":0.75}
                text: ""
    TabbedPanelItem:
        text: "Uniform Stimulation"

<DeviceTabs@TabbedPanel+DT_TPS>:
    stimulation_log_tab: stimulation_log_tab
    advanced_settings: advanced_settings
    size_hint: 1,1
    pos_hint: {"top":1}
    do_default_tab: False
    tab_width: (self.parent.width)/4
    tab_pos : 'top_mid'
    TabbedPanelItem:
        text: "Stimulation Setting"
        DeviceSettings:
    TabbedPanelItem:
        text: "Stimulation Log"
        StimulationLogTab:
            id: stimulation_log_tab
    TabbedPanelItem:
        text: "EEG recording"
    TabbedPanelItem:
        text: "Advanced Settings"
        DeviceAdvancedSettings:
            id: advanced_settings
<DT_TPS@TabbedPanelStrip>
    canvas:
        Color:
            rgba: 0, 1, 0, 1
        Rectangle:
            size: self.size
            pos: self.pos


<StimulationLogTab@FloatLayout>:
    top_graph:top_graph
    bottom_graph:bottom_graph
    size_hint: 1,1
    pos_hint: {"x":0, "top":1}
    Label:
        text: "Sample info (1k)"
        size_hint: .16, .08
        pos_hint: {"x":0.05,"top":0.95}
    TextInput:
        text: "0"
        size_hint: .16, .06
        pos_hint: {"x":0.25,"top":0.94}
        multiline:False
    Button:
        size_hint: .16,0.06
        pos_hint: {"x":0.59,"top":0.94}
        text: "Stop"
    Button:
        size_hint: .16,0.06
        pos_hint: {"x":0.79,"top":0.94}
        text: "Recording..."
    Button:
        size_hint: .16,0.06
        pos_hint: {"x":0.79,"top":0.85}
        text: "Save Log"
    FloatLayout:
        id: top_graph
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        size_hint: .9,0.33
        pos_hint: {"x":0.05,"top":0.75}
    FloatLayout:
        id: bottom_graph
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        size_hint: .9,0.33
        pos_hint: {"x":0.05,"top":0.375}

<DeviceAdvancedSettings@FloatLayout>:
    size_hint: 1,1
    pos_hint: {"x":0, "top":1}
    Label:
        text: "General"
        font_size: 15
        size_hint: 0.9, .08
        pos_hint: {"x":0.05,"top":1}
        multiline: False
        text_size:self.size
        halign:'left'
        valign:'middle'
    Label:
        text: "Stimulation Setting"
        font_size: 15
        size_hint: 0.9, .08
        pos_hint: {"x":0.05,"top":0.7}
        multiline: False
        text_size:self.size
        halign:'left'
        valign:'middle'
    StrokeButton:
        size_hint: 0.425, .08
        pos_hint: {"x":0.05,"top":0.9}
        font_size: 13
        text: "Auto shutdown when stimulation is finished"
    StrokeButton:
        size_hint: 0.425, .08
        pos_hint: {"x":0.525,"top":0.9}
        font_size: 13
        text: "Auto shutdown when surge is detected"


<SmoothButton@ToggleButton>:
    background_color: 1,0,1,1 if self.state=='down' else (0, 0, 0, 1)
    background_normal: ''
    back_color: 1,0,1,1
    border_radius: [5]
    canvas.before:
        Color:
            rgba: self.back_color
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: self.border_radius

<StrokeButton@Button>:
    background_color: 1,0,1,1 if self.state!='down' else 0, 0, 0, 1
    background_normal: ''
    back_color: 0.16, 0.45, 0.75, 1
    border_radius: 5
    color: 0,0,0,1
    bold: True
    canvas.before:
        Color:
            rgba: self.back_color
        Line:
            rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], self.border_radius)
            width: 1.2

##################################################